<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>WOLEA AI â€” ì˜ˆë°°ì¸ë„ì ì›Œë¦¬ì–´</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background: #f9fafb; overflow: hidden; }
  .font-brand { font-family: 'Montserrat', sans-serif; }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  input, textarea, select { font-family: 'Noto Sans KR', sans-serif; }
  button { cursor: pointer; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .animate-spin { animation: spin 1s linear infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  .animate-pulse { animation: pulse 2s cubic-bezier(.4,0,.6,1) infinite; }
  @keyframes fade-in { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .fade-in { animation: fade-in 0.3s ease forwards; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* â”€â”€â”€ SVG ICONS â”€â”€â”€ */
const Icon = ({ d, size=24, stroke="#000", fill="none", sw=2, className="" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke={stroke} strokeWidth={sw} strokeLinecap="round" strokeLinejoin="round" className={className}>
    {Array.isArray(d) ? d.map((p,i)=><path key={i} d={p}/>) : <path d={d}/>}
  </svg>
);
const icons = {
  sparkles: ["M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z","M18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z"],
  folder: "M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z",
  users: "M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z",
  music: "M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z",
  user: "M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z",
  search: "M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z",
  externalLink: ["M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5","M7.5 3h13.5v13.5","M7.5 16.5L21 3"],
  bookOpen: ["M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"],
  alertCircle: ["M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z","M12 15.75h.007v.008H12v-.008z"],
  chevronLeft: "M15.75 19.5L8.25 12l7.5-7.5",
  loader: "M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83",
  trash2: "M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0",
  share2: "M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z",
  rotateLeft: "M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3",
  trash: "M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0",
  bell: "M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0",
  settings: "M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z M15 12a3 3 0 11-6 0 3 3 0 016 0z",
  help: "M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z",
  info: "M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z",
  shield: "M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z",
  logout: "M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9",
  heart: "M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z",
  messageCircle: "M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z",
  youtube: ["M2.5 17a24.12 24.12 0 010-10 2 2 0 011.4-1.4 49.56 49.56 0 0116.2 0A2 2 0 0121.5 7a24.12 24.12 0 010 10 2 2 0 01-1.4 1.4 49.55 49.55 0 01-16.2 0A2 2 0 012.5 17","M10 15l5-3-5-3z"],
  fileMusic: ["M9 19a3 3 0 10-6 0 3 3 0 006 0zm0 0V7.5l12-3V16","M9 19H3","M21 13V7.5L9 4.5"],
  check: "M4.5 12.75l6 6 9-13.5",
  xMark: "M6 18L18 6M6 6l12 12",
};

const I = ({ name, size=20, stroke="currentColor", fill="none", sw=1.5, className="" }) => (
  <Icon d={icons[name]} size={size} stroke={stroke} fill={fill} sw={sw} className={className} />
);

/* â”€â”€â”€ LOGO â”€â”€â”€ */
function Logo({ size="md" }) {
  const s = { sm:"text-2xl", md:"text-3xl", lg:"text-4xl" }[size];
  return (
    <div className="text-center">
      <h1 className={`${s} font-brand font-black tracking-tight bg-gradient-to-r from-teal-500 to-blue-500 bg-clip-text text-transparent`}>WOLEA</h1>
      <p className="text-xs text-gray-400 mt-1 tracking-widest uppercase">ì˜ˆë°°ì¸ë„ì ì›Œë¦¬ì–´</p>
    </div>
  );
}

/* â”€â”€â”€ CUSTOM ALERT â”€â”€â”€ */
function CustomAlert({ isOpen, onClose, title, message, type="info" }) {
  if (!isOpen) return null;
  const colors = { info:"border-blue-400 bg-blue-50", success:"border-teal-400 bg-teal-50", warning:"border-yellow-400 bg-yellow-50", error:"border-red-400 bg-red-50" };
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center px-6" style={{background:"rgba(0,0,0,0.4)"}}>
      <div className={`bg-white rounded-2xl shadow-2xl w-full max-w-sm border-2 ${colors[type]} overflow-hidden fade-in`}>
        <div className="p-6">
          {title && <h3 className="font-bold text-gray-900 mb-2">{title}</h3>}
          <p className="text-sm text-gray-700 whitespace-pre-line">{message}</p>
        </div>
        <div className="border-t border-gray-100 px-6 py-4">
          <button onClick={onClose} className="w-full py-2.5 bg-gray-900 text-white rounded-xl text-sm font-semibold hover:bg-gray-700 transition-colors">í™•ì¸</button>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ BOTTOM NAV â”€â”€â”€ */
function BottomNav({ activeTab, onTabChange }) {
  const tabs = [
    { id:"ai", icon:"sparkles", label:"AI ì½˜í‹°" },
    { id:"setlists", icon:"folder", label:"ë‚´ ì½˜í‹°" },
    { id:"community", icon:"users", label:"ì»¤ë®¤ë‹ˆí‹°" },
    { id:"music", icon:"music", label:"ì•…ë³´" },
    { id:"profile", icon:"user", label:"ë‚´ ì •ë³´" },
  ];
  return (
    <nav className="fixed bottom-0 left-0 right-0 z-40" style={{background:"linear-gradient(135deg,#111827,#1f2937)"}}>
      <div className="h-0.5" style={{background:"linear-gradient(90deg,#14b8a6,#3b82f6,#14b8a6)"}}/>
      <div className="flex items-center justify-around h-20">
        {tabs.map(t => {
          const active = activeTab===t.id;
          return (
            <button key={t.id} onClick={()=>onTabChange(t.id)} className="flex flex-col items-center flex-1 h-full justify-center relative">
              {active && <div className="absolute top-0 left-1/2 -translate-x-1/2 w-10 h-1 rounded-b-full" style={{background:"linear-gradient(90deg,#14b8a6,#3b82f6)"}}/>}
              <I name={t.icon} size={22} stroke={active?"#fff":"#9ca3af"} className={active?"scale-110":""}/>
              <span className={`text-xs mt-1 ${active?"text-white font-semibold":"text-gray-400"}`}>{t.label}</span>
            </button>
          );
        })}
      </div>
    </nav>
  );
}

/* â”€â”€â”€ WELCOME SCREEN â”€â”€â”€ */
function WelcomeScreen({ onContinue }) {
  return (
    <div className="h-full flex items-center justify-center px-6 relative overflow-hidden" style={{background:"linear-gradient(135deg,#111827,#1f2937,#000)"}}>
      <div className="absolute top-0 right-0 w-96 h-96 rounded-full blur-3xl" style={{background:"rgba(20,184,166,0.08)"}}/>
      <div className="absolute bottom-0 left-0 w-96 h-96 rounded-full blur-3xl" style={{background:"rgba(59,130,246,0.08)"}}/>
      <div className="w-full max-w-md relative z-10 fade-in">
        <div className="mb-12"><Logo size="lg"/></div>
        <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-10 text-center border border-gray-200">
          <h2 className="text-2xl mb-6 text-gray-900 font-semibold">ì•ˆë…•í•˜ì„¸ìš”</h2>
          <p className="text-base text-gray-600 leading-relaxed mb-10">ì˜ˆë°°ì¸ë„ì ì›Œë¦¬ì–´(Wolea) ì—¬ëŸ¬ë¶„,<br/>ì €ëŠ” Wolea.Ai ì…ë‹ˆë‹¤.</p>
          <button onClick={onContinue} className="w-full py-4 text-white rounded-xl font-semibold shadow-lg hover:opacity-90 transition-opacity" style={{background:"linear-gradient(135deg,#0d9488,#2563eb)"}}>ë°˜ê°‘ìŠµë‹ˆë‹¤</button>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ MEDITATION INPUT SCREEN â”€â”€â”€ */
function MeditationInputScreen({ onSubmit }) {
  const [input, setInput] = useState('');
  const [error, setError] = useState('');
  const MIN=20, MAX=1000;

  const validate = (text) => {
    if (text.length<MIN){setError(`ìµœì†Œ ${MIN}ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.`);return false;}
    if (text.length>MAX){setError(`ìµœëŒ€ ${MAX}ìê¹Œì§€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);return false;}
    if (/(.).\1{9,}/.test(text)){setError('ì˜¬ë°”ë¥¸ ë¬µìƒ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return false;}
    const hasKw=/ì„±ê²½|ë§ì”€|ì£¼ë‹˜|í•˜ë‚˜ë‹˜|ì˜ˆìˆ˜|ì°¬ì–‘|ì˜ˆë°°|ê¸°ë„|ë¬µìƒ|ë³µìŒ|ì€í˜œ|ì‚¬ë‘|ë¯¿ìŒ|ì†Œë§|ì°½ì„¸ê¸°|ì¶œì• êµ½ê¸°|ì‹œí¸|ì ì–¸|ë§ˆíƒœë³µìŒ|ìš”í•œë³µìŒ|ì¥|ì ˆ/.test(text);
    if (!hasKw&&text.length<50){setError('ì„±ê²½ êµ¬ì ˆì´ë‚˜ ì˜ˆë°° ê´€ë ¨ ì£¼ì œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.');return false;}
    setError(''); return true;
  };

  const handleSubmit = () => {
    const t=input.trim();
    if (t && validate(t)) onSubmit(t);
  };

  return (
    <div className="h-full flex flex-col px-6 py-12 bg-white relative">
      <div className="absolute top-0 left-0 right-0 h-1" style={{background:"linear-gradient(90deg,#111827,#0d9488,#2563eb)"}}/>
      <div className="flex-1 flex flex-col max-w-md mx-auto w-full">
        <div className="mb-8 relative">
          <div className="absolute -left-4 top-0 bottom-0 w-1 bg-gray-900 rounded-full"/>
          <h2 className="text-xl mb-4 text-gray-900 font-semibold leading-relaxed">ì €ëŠ” ë‹¹ì‹ ì˜ ì„±ê²½ê³¼ ì°¬ì–‘ ë¬µìƒì„<br/>ëŒ€ì‹ í•´ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.</h2>
          <p className="text-base text-gray-600">ì˜¤ëŠ˜ì€ ì–´ë–¤ ë¬µìƒì„ í•˜ì…¨ë‚˜ìš”?</p>
          <p className="text-sm text-gray-400 mt-1">ì„±ê²½ êµ¬ì ˆì´ë‚˜ ì˜ˆë°° ì£¼ì œë¥¼ í¬í•¨í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš” (ìµœì†Œ 20ì ì´ìƒ)</p>
        </div>
        <div className="flex-1 mb-4 relative">
          <textarea
            value={input}
            onChange={e=>{ if(e.target.value.length<=MAX){setInput(e.target.value);setError('');} }}
            placeholder={"ì˜ˆì‹œ:\n\në§ˆíƒœë³µìŒ 5ì¥ 3-10ì ˆì˜ íŒ”ë³µì— ëŒ€í•´ ë¬µìƒí–ˆìŠµë‹ˆë‹¤.\nì‹¬ë ¹ì´ ê°€ë‚œí•œ ìê°€ ë³µì´ ìˆë‹¤ëŠ” ë§ì”€ì´ ë§ˆìŒì— ì™€ë‹¿ì•˜ìŠµë‹ˆë‹¤."}
            className={`w-full h-full min-h-[280px] px-4 py-4 border-2 ${error?'border-red-400 bg-red-50':'border-gray-900 bg-gray-50'} rounded-xl text-gray-900 placeholder-gray-400 resize-none focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-100 transition-colors`}
          />
          <div className="absolute bottom-3 right-3 bg-white/80 backdrop-blur-sm px-2 py-1 rounded text-xs font-medium" style={{color:input.length<MIN?'#ef4444':'#374151'}}>{input.length}/{MAX}</div>
        </div>
        {error && (
          <div className="mb-4 p-3 bg-red-50 border-2 border-red-200 rounded-xl flex items-start gap-2">
            <I name="alertCircle" size={18} stroke="#dc2626"/>
            <p className="text-sm text-red-800">{error}</p>
          </div>
        )}
        <button onClick={handleSubmit} disabled={input.length<MIN} className="w-full py-4 bg-gray-900 text-white rounded-xl font-semibold shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-gray-800 transition-colors">ë” ê¹Šì€ ë¬µìƒì„ ìœ„í•œ ì œì•ˆ ë°›ê¸°</button>
      </div>
    </div>
  );
}

/* â”€â”€â”€ MEDITATION GUIDANCE SCREEN â”€â”€â”€ */
function MeditationGuidanceScreen({ onContinue, onBack, countdown, setCountdown, meditationInput }) {
  const [isGenerating, setIsGenerating] = useState(true);
  const [content, setContent] = useState('');
  const [verses, setVerses] = useState([]);
  const isComplete = countdown!==null && countdown<=0;

  useEffect(()=>{
    if(countdown!==null&&countdown>0){
      const t=setTimeout(()=>setCountdown(countdown-1),1000);
      return()=>clearTimeout(t);
    }
  },[countdown]);

  // â˜… APIë¥¼ í˜¸ì¶œí•´ì„œ ë™ì  ë¬µìƒ ê°€ì´ë“œë¥¼ ë°›ì•„ì˜¤ëŠ” ë¶€ë¶„ â˜…
  useEffect(()=>{
    const fetchGuidance = async () => {
      try {
        const res = await fetch('/api/meditation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ input: meditationInput })
        });
        const data = await res.json();
        if(data.error) throw new Error(data.error);
        
        setContent(data.guide);
        setVerses(data.verses || []);
      } catch (error) {
        setContent('ë¬µìƒ ë‚´ìš©ì„ ë¶„ì„í•˜ëŠ” ì¤‘ ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ ì¡°ìš©íˆ í•˜ë‚˜ë‹˜ì„ ë°”ë¼ë³´ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”.');
        setVerses(['ì‹œí¸ 62:1 - ë‚˜ì˜ ì˜í˜¼ì´ ì ì íˆ í•˜ë‚˜ë‹˜ë§Œ ë°”ëŒì´ì—¬ ë‚˜ì˜ êµ¬ì›ì´ ê·¸ì—ê²Œì„œ ë‚˜ì˜¤ëŠ”ë„ë‹¤']);
      } finally {
        setIsGenerating(false);
      }
    };
    
    fetchGuidance();
  },[meditationInput]);

  return (
    <div className="h-full flex flex-col px-6 py-8 bg-gradient-to-br from-gray-50 to-gray-100 relative overflow-hidden">
      <button onClick={onBack} className="flex items-center gap-1 text-gray-500 hover:text-gray-900 mb-6 transition-colors">
        <I name="chevronLeft" size={18} stroke="currentColor"/><span className="text-sm font-medium">ë’¤ë¡œê°€ê¸°</span>
      </button>
      <div className="flex-1 overflow-y-auto scrollbar-hide">
        <div className="max-w-md mx-auto pb-6 space-y-4 fade-in">
          
          {/* AI ë¬µìƒ ê°€ì´ë“œ ì¹´ë“œ */}
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200">
            <div className="px-6 py-3" style={{background:"linear-gradient(135deg,#111827,#1f2937)"}}><p className="text-sm text-white font-semibold">AI ë¬µìƒ ê°€ì´ë“œ</p></div>
            <div className="p-6">
              {isGenerating ? (
                <div className="flex flex-col items-center justify-center py-6 gap-3">
                  <div className="w-8 h-8 border-4 border-teal-200 border-t-teal-500 rounded-full animate-spin"></div>
                  <span className="text-sm text-gray-500 font-medium">ë‚˜ëˆ”í•´ì£¼ì‹  ë¬µìƒì„ ê¹Šì´ ì½ê³  ìˆìŠµë‹ˆë‹¤...</span>
                </div>
              ) : <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-line">{content}</p>}
            </div>
          </div>

          {/* ì¶”ì²œ ì„±ê²½ êµ¬ì ˆ ì¹´ë“œ */}
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200">
            <div className="px-6 py-3" style={{background:"linear-gradient(135deg,#111827,#1f2937)"}}><p className="text-sm text-white font-semibold">ì¶”ì²œ ì„±ê²½ êµ¬ì ˆ</p></div>
            <div className="p-6">
              {isGenerating ? (
                <div className="animate-pulse space-y-4">
                  <div className="h-4 bg-gray-200 rounded w-3/4"></div>
                  <div className="h-4 bg-gray-200 rounded w-5/6"></div>
                  <div className="h-4 bg-gray-200 rounded w-2/3"></div>
                </div>
              ) : (
                verses.map((v,i)=>(
                  <p key={i} className="text-sm text-gray-700 leading-relaxed pl-4 border-l-2 border-teal-500 mb-3">{v}</p>
                ))
              )}
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow-lg p-6 border-2 border-gray-900">
            <p className="text-sm text-gray-700 mb-4 font-medium">ì´ˆì›(Chowon)ì—ì„œ ë” ê¹Šì´ ë¬µìƒí•˜ê¸°</p>
            <a href="https://chowon.in/home" target="_blank" rel="noopener noreferrer" className="block w-full py-3 bg-gray-900 text-white rounded-xl text-sm text-center font-semibold hover:bg-gray-800 transition-colors">ì´ˆì› ì•±ìœ¼ë¡œ ì´ë™ â†’</a>
          </div>
          
          <button onClick={onContinue} disabled={!isComplete} className="w-full py-4 text-white rounded-xl font-semibold shadow-lg disabled:opacity-40 disabled:cursor-not-allowed hover:opacity-90 transition-opacity" style={{background:"linear-gradient(135deg,#0d9488,#2563eb)"}}>
            {isComplete?'ê³„ì†í•˜ê¸°':`ë¬µìƒ ì‹œê°„: ${countdown}ì´ˆ`}
          </button>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ WORSHIP INFO SCREEN â”€â”€â”€ */
function WorshipInfoScreen({ onSubmit }) {
  const [f,setF]=useState({serviceType:'',theme:'',congregation:'',duration:'',churchCalendar:'',specialNotes:''});
  const valid=f.serviceType&&f.theme&&f.duration;
  return (
    <div className="h-full px-6 py-12 bg-gradient-to-br from-gray-50 to-gray-100 overflow-y-auto scrollbar-hide">
      <div className="max-w-md mx-auto pb-6 fade-in">
        <div className="mb-8 relative"><div className="absolute -left-4 top-0 bottom-0 w-1 bg-gray-900 rounded-full"/><h2 className="text-2xl text-gray-900 font-bold">ì˜ˆë°° ì¤€ë¹„ ì •ë³´</h2></div>
        {[
          { title:'í•„ìˆ˜ ì •ë³´', fields:[
            {label:'ì˜ˆë°° ìœ í˜• *',key:'serviceType',placeholder:'ì˜ˆ: ì£¼ì¼ì˜ˆë°°, ì²­ë…„ì˜ˆë°°, ìˆ˜ìš”ì˜ˆë°°'},
            {label:'ì˜ˆë°° ì£¼ì œ ë˜ëŠ” ì„¤êµ ë³¸ë¬¸ *',key:'theme',placeholder:'ì˜ˆ: ìš”í•œë³µìŒ 3ì¥ 16ì ˆ - í•˜ë‚˜ë‹˜ì˜ ì‚¬ë‘'},
            {label:'ì°¬ì–‘ ì‹œê°„ (ë¶„) *',key:'duration',type:'number',placeholder:'20'},
          ]},
          { title:'ì¶”ê°€ ì •ë³´ (ì„ íƒ)', fields:[
            {label:'íšŒì¤‘ íŠ¹ì„±',key:'congregation',placeholder:'ì˜ˆ: ëŒ€í•™ìƒ ì¤‘ì‹¬, ì²­ì¥ë…„ì¸µ'},
            {label:'êµíšŒë ¥/ì ˆê¸°',key:'churchCalendar',placeholder:'ì˜ˆ: ì‚¬ìˆœì ˆ, ë¶€í™œì ˆ'},
          ]},
        ].map(sec=>(
          <div key={sec.title} className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200 mb-4">
            <div className="px-6 py-3" style={{background:"linear-gradient(135deg,#111827,#1f2937)"}}><p className="text-sm text-white font-semibold">{sec.title}</p></div>
            <div className="p-6 space-y-4">
              {sec.fields.map(fd=>(
                <div key={fd.key}>
                  <label className="block text-sm text-gray-700 mb-2 font-medium">{fd.label}</label>
                  <input type={fd.type||'text'} value={f[fd.key]} onChange={e=>setF({...f,[fd.key]:e.target.value})} placeholder={fd.placeholder} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-100 transition-colors"/>
                </div>
              ))}
            </div>
          </div>
        ))}
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200 mb-4">
          <div className="px-6 py-3" style={{background:"linear-gradient(135deg,#1f2937,#374151)"}}><p className="text-sm text-white font-semibold">íŠ¹ë³„ ìš”ì²­ì‚¬í•­</p></div>
          <div className="p-6"><textarea value={f.specialNotes} onChange={e=>setF({...f,specialNotes:e.target.value})} placeholder="ì˜ˆ: í…œí¬ê°€ ëŠë¦° ê³¡ ìœ„ì£¼ë¡œ, íšŒì¤‘ì´ ì˜ ì•„ëŠ” ê³¡ í¬í•¨" rows={4} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 resize-none focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-100 transition-colors"/></div>
        </div>
        <button onClick={()=>valid&&onSubmit(f)} disabled={!valid} className="w-full py-4 bg-gray-900 text-white rounded-xl font-semibold shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-gray-800 transition-colors">AI ì½˜í‹° ìƒì„±í•˜ê¸°</button>
      </div>
    </div>
  );
}

/* â”€â”€â”€ GENERATING SCREEN â”€â”€â”€ */
function GeneratingScreen() {
  return (
    <div className="h-full flex items-center justify-center bg-gradient-to-br from-teal-50 to-blue-50">
      <div className="text-center fade-in">
        <div className="w-16 h-16 border-4 border-teal-200 border-t-teal-500 rounded-full animate-spin mx-auto mb-6"/>
        <p className="text-lg text-gray-700 font-medium">Wolea ìƒê°ì¤‘â€¦</p>
      </div>
    </div>
  );
}

/* â”€â”€â”€ SETLIST RESULT SCREEN â”€â”€â”€ */
function SetlistResultScreen({ generatedSongs, meditationData, worshipData, onStartOver, onRegenerate, onViewSheetMusic, onEditSetlist }) {
  const [editPrompt,setEditPrompt]=useState('');
  const [ytResults,setYtResults]=useState({});

  const handleYoutubeClick=async(song)=>{
    const key=song.order;
    if(ytResults[key]?.open){
      setYtResults(prev=>({...prev,[key]:{...prev[key],open:false}})); return;
    }
    if(ytResults[key]?.items){
      setYtResults(prev=>({...prev,[key]:{...prev[key],open:true}})); return;
    }
    setYtResults(prev=>({...prev,[key]:{loading:true,open:true,items:null}}));
    try{
      const res=await fetch(`/api/youtube?query=${encodeURIComponent(song.title+' '+song.artist)}`);
      const data=await res.json();
      setYtResults(prev=>({...prev,[key]:{loading:false,open:true,items:data.items||[]}}));
    }catch(e){
      setYtResults(prev=>({...prev,[key]:{loading:false,open:true,items:[]}}));
    }
  };

  return (
    <div className="h-full px-6 py-12 bg-gradient-to-br from-gray-50 to-gray-100 overflow-y-auto scrollbar-hide">
      <div className="max-w-2xl mx-auto pb-6 fade-in">
        <div className="mb-8 relative">
          <div className="absolute -left-4 top-0 bottom-0 w-1 bg-gray-900 rounded-full"/>
          <h2 className="text-2xl text-gray-900 font-bold">ìƒì„±ëœ ì°¬ì–‘ ì½˜í‹°</h2>
          <p className="text-sm text-gray-500 mt-1">ì´ {generatedSongs?.length || 0}ê³¡ â€¢ ì˜ˆìƒ ì‹œê°„ ì•½ {worshipData?.duration||'20'}ë¶„</p>
          <p className="text-xs text-teal-600 mt-1 font-medium">âœ“ ë¬µìƒ ì£¼ì œ ë°˜ì˜ â€¢ âœ“ ì‹¤ì œ ìŒì› êµì°¨ ê²€ì¦ ì™„ë£Œ</p>
        </div>
        {meditationData?.input && (
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200 mb-6">
            <div className="px-6 py-3" style={{background:"linear-gradient(135deg,#0d9488,#2563eb)"}}><p className="text-sm text-white font-semibold">ë¬µìƒ ì£¼ì œ</p></div>
            <div className="p-4"><p className="text-sm text-gray-700">"{meditationData.input}"</p></div>
          </div>
        )}
        <div className="space-y-4 mb-8">
          {generatedSongs && generatedSongs.map(song=>{
            const yt=ytResults[song.order]||{};
            return (
            <div key={song.order} className="bg-white rounded-2xl border-2 border-gray-200 p-6 shadow-lg">
              <div className="flex items-start justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl flex items-center justify-center shadow-md" style={{background:"linear-gradient(135deg,#111827,#374151)"}}><span className="text-white font-bold text-lg">{song.order}</span></div>
                  <div>
                    <span className="inline-block px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-lg font-medium mr-1">{song.position}</span>
                    <span className="inline-block px-2 py-1 bg-teal-50 text-teal-700 text-xs rounded-lg font-medium">{song.bpm} BPM</span>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button onClick={()=>onViewSheetMusic(song.title,song.artist)} className="p-2 border-2 border-gray-200 rounded-xl hover:border-gray-900 transition-colors" title="ì•…ë³´ ë³´ê¸°"><I name="fileMusic" size={18} stroke="#374151"/></button>
                  <a href={song.spotifyUrl} target="_blank" rel="noopener noreferrer" className={`p-2 border-2 rounded-xl transition-colors ${song.isVerified ? 'border-green-200 hover:border-green-500' : 'border-gray-200 opacity-50'}`} title={song.isVerified ? "Spotifyì—ì„œ ë“£ê¸°" : "Spotify ê²€ìƒ‰"}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill={song.isVerified ? "#1DB954" : "#9ca3af"}><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                  </a>
                  <button onClick={()=>handleYoutubeClick(song)} className={`p-2 border-2 rounded-xl transition-colors ${yt.open?'border-red-500 bg-red-50':'border-red-100 hover:border-red-400'}`} title="YouTube ê²€ìƒ‰">
                    {yt.loading
                      ? <div className="w-4 h-4 border-2 border-red-300 border-t-red-600 rounded-full animate-spin"/>
                      : <I name="youtube" size={18} stroke="#dc2626"/>
                    }
                  </button>
                </div>
              </div>
              <h3 className="text-lg font-bold text-gray-900 mb-1">{song.title} {song.isVerified && <span className="text-xs text-green-600 font-medium">âœ“ í™•ì¸ë¨</span>}</h3>
              <p className="text-sm text-gray-500 mb-3">{song.artist}</p>
              <div className="mb-4"><span className="px-3 py-1 bg-gray-900 text-white rounded-lg text-sm font-semibold">ì¶”ì²œ Key: {song.key}</span></div>

              {yt.open && (
                <div className="mb-4 border-2 border-red-100 rounded-xl overflow-hidden">
                  <div className="flex items-center justify-between px-4 py-2" style={{background:"#ff0000"}}>
                    <div className="flex items-center gap-2"><I name="youtube" size={16} stroke="#fff" fill="#fff"/>
                      <span className="text-xs text-white font-bold">YouTube ê²€ìƒ‰ ê²°ê³¼</span>
                    </div>
                    <button onClick={()=>setYtResults(prev=>({...prev,[song.order]:{...prev[song.order],open:false}}))} className="text-white/70 hover:text-white text-xs">âœ• ë‹«ê¸°</button>
                  </div>
                  {yt.loading && (
                    <div className="p-6 text-center"><div className="w-8 h-8 border-2 border-red-200 border-t-red-500 rounded-full animate-spin mx-auto mb-2"/><p className="text-xs text-gray-400">ê²€ìƒ‰ ì¤‘...</p></div>
                  )}
                  {!yt.loading && yt.items?.length===0 && (
                    <div className="p-4 text-center"><p className="text-sm text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”</p></div>
                  )}
                  {!yt.loading && yt.items?.length>0 && (
                    <div className="divide-y divide-gray-100">
                      {yt.items.map(v=>(
                        <a key={v.videoId} href={v.url} target="_blank" rel="noopener noreferrer" className="flex gap-3 p-3 hover:bg-gray-50 transition-colors">
                          <img src={v.thumbnail} alt={v.title} className="w-24 h-16 object-cover rounded-lg flex-shrink-0"/>
                          <div className="flex-1 min-w-0">
                            <p className="text-xs font-semibold text-gray-900 line-clamp-2 leading-snug mb-1">{v.title}</p>
                            <p className="text-xs text-gray-400">{v.channel}</p>
                          </div>
                        </a>
                      ))}
                    </div>
                  )}
                </div>
              )}

              <div className="border-t border-gray-100 my-3"/>
              <div className="mb-3 bg-gray-50 rounded-xl p-4 border-l-4 border-teal-500">
                <p className="text-xs text-teal-700 font-bold mb-1">ê°€ì‚¬ ì¼ë¶€</p>
                <p className="text-sm text-gray-700 italic">{song.lyrics}</p>
              </div>
              <div className="mb-3">
                <p className="text-xs font-bold text-gray-900 mb-1">ì„ ê³¡ ì´ìœ </p>
                <p className="text-sm text-gray-700 leading-relaxed">{song.reason}</p>
              </div>
              <div className="bg-teal-50 rounded-xl p-4 border-l-4 border-gray-900">
                <p className="text-xs font-bold text-gray-900 mb-1">ê´€ë ¨ ì„±ê²½ êµ¬ì ˆ</p>
                <p className="text-sm text-gray-800">{song.verse}</p>
              </div>
            </div>
          );})}
        </div>
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200 mb-4">
          <div className="px-6 py-3" style={{background:"linear-gradient(135deg,#1f2937,#374151)"}}><p className="text-sm text-white font-semibold">ì½˜í‹° ìˆ˜ì •í•˜ê¸°</p></div>
          <div className="p-6">
            <div className="flex gap-2">
              <input type="text" value={editPrompt} onChange={e=>setEditPrompt(e.target.value)} placeholder="ì˜ˆ: í…œí¬ë¥¼ ë” ë¹ ë¥´ê²Œ, íšŒì¤‘ ì°¬ì–‘ ìœ„ì£¼ë¡œ" className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-teal-500 focus:outline-none text-sm"/>
              <button onClick={()=>{if(editPrompt.trim()){onEditSetlist(editPrompt);setEditPrompt('');}}} className="px-5 py-3 bg-gray-900 text-white rounded-xl text-sm font-semibold hover:bg-gray-800 transition-colors">ìˆ˜ì •</button>
            </div>
          </div>
        </div>
        <div className="flex gap-3">
          <button onClick={onRegenerate} className="flex-1 py-4 text-white rounded-xl font-semibold shadow-lg hover:opacity-90 transition-opacity" style={{background:"linear-gradient(135deg,#0d9488,#2563eb)"}}>ë‹¤ì‹œ ìƒì„±í•˜ê¸°</button>
          <button onClick={onStartOver} className="flex-1 py-4 border-2 border-gray-900 text-gray-900 rounded-xl font-semibold hover:bg-gray-50 transition-colors">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ MY SETLISTS SCREEN â”€â”€â”€ */
function MySetlistsScreen({ setlists, deletedSetlists, onViewSetlist, onDeleteSetlist, onRestoreSetlist, onPermanentDelete, isLoggedIn }) {
  const [showTrash,setShowTrash]=useState(false);
  const getRem=(d)=>{ if(!d)return 0; return Math.max(0,Math.ceil((30*864e5-(Date.now()-d))/864e5)); };
  return (
    <div className="h-full bg-gray-50 overflow-y-auto scrollbar-hide">
      <div className="px-6 py-8 shadow-lg" style={{background:"linear-gradient(135deg,#111827,#1f2937)"}}>
        <div className="max-w-2xl mx-auto flex justify-between items-center">
          <h2 className="text-2xl text-white font-bold">ë‚´ ì½˜í‹° ì €ì¥ì†Œ</h2>
          <button onClick={()=>setShowTrash(!showTrash)} className="flex items-center gap-2 px-4 py-2 bg-white/10 border border-white/20 rounded-xl text-sm text-white hover:bg-white/20 transition-colors">
            <I name="trash" size={16} stroke="#fff"/><span>íœ´ì§€í†µ{deletedSetlists.length>0&&` (${deletedSetlists.length})`}</span>
          </button>
        </div>
      </div>
      <div className="px-6 py-6 pb-6">
        <div className="max-w-2xl mx-auto fade-in">
          {!isLoggedIn&&setlists.length>0&&<div className="bg-amber-50 border-l-4 border-amber-500 rounded-xl p-4 mb-4 text-sm text-gray-700">âš ï¸ ë¹„íšŒì› ëª¨ë“œ: ìƒˆë¡œê³ ì¹¨ ì‹œ ì‚­ì œë©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì˜êµ¬ ì €ì¥í•˜ì„¸ìš”.</div>}
          {showTrash ? (
            <>
              <button onClick={()=>setShowTrash(false)} className="text-sm text-gray-900 font-medium mb-4 hover:text-teal-600 transition-colors">â† ë‚´ ì½˜í‹°ë¡œ ëŒì•„ê°€ê¸°</button>
              {deletedSetlists.length===0
                ? <div className="bg-white rounded-2xl border-2 border-gray-200 p-12 text-center"><p className="text-gray-400">íœ´ì§€í†µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</p></div>
                : deletedSetlists.map(s=>(
                  <div key={s.id} className="bg-white rounded-2xl border-2 border-gray-200 shadow-sm mb-3 overflow-hidden opacity-75">
                    <div className="p-5">
                      <h3 className="font-semibold text-gray-900">{s.theme}</h3>
                      <p className="text-sm text-gray-400 mt-1">{s.date} â€¢ {s.serviceType} â€¢ <span className="text-red-500">{getRem(s.deletedAt)}ì¼ í›„ ì˜êµ¬ ì‚­ì œ</span></p>
                    </div>
                    <div className="border-t border-gray-100 px-5 py-3 flex gap-3 bg-gray-50">
                      <button onClick={()=>onRestoreSetlist(s.id)} className="flex-1 flex items-center justify-center gap-2 py-2 bg-gray-900 text-white rounded-xl text-sm font-semibold"><I name="rotateLeft" size={15} stroke="#fff"/>ë³µì›</button>
                      <button onClick={()=>{if(confirm('ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))onPermanentDelete(s.id);}} className="flex-1 flex items-center justify-center gap-2 py-2 border-2 border-red-500 text-red-500 rounded-xl text-sm font-semibold"><I name="trash2" size={15} stroke="#ef4444"/>ì˜êµ¬ ì‚­ì œ</button>
                    </div>
                  </div>
                ))
              }
            </>
          ) : (
            setlists.length===0
              ? <div className="bg-white rounded-2xl border-2 border-gray-200 p-12 text-center"><p className="text-gray-400 mb-2">ì €ì¥ëœ ì½˜í‹°ê°€ ì—†ìŠµë‹ˆë‹¤</p><p className="text-sm text-gray-300">AI ì½˜í‹°ë¥¼ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤</p></div>
              : setlists.map(s=>(
                <div key={s.id} className="bg-white rounded-2xl border-2 border-gray-200 shadow-sm mb-3 overflow-hidden hover:border-gray-900 hover:shadow-lg transition-all">
                  <div onClick={()=>onViewSetlist(s.id)} className="p-5 cursor-pointer">
                    <h3 className="font-semibold text-gray-900">{s.theme}</h3>
                    <p className="text-sm text-gray-400 mt-1">{s.date} â€¢ {s.serviceType}</p>
                  </div>
                  <div className="border-t border-gray-100 px-5 py-3 flex gap-3 bg-gray-50">
                    <button onClick={()=>{if(navigator.share)navigator.share({title:`ì°¬ì–‘ ì½˜í‹°: ${s.theme}`,url:location.href}).catch(()=>{});else alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');}} className="flex-1 flex items-center justify-center gap-2 py-2 bg-gray-900 text-white rounded-xl text-sm font-semibold"><I name="share2" size={15} stroke="#fff"/>ê³µìœ </button>
                    <button onClick={()=>{if(confirm('ì½˜í‹°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))onDeleteSetlist(s.id);}} className="flex-1 flex items-center justify-center gap-2 py-2 border-2 border-red-500 text-red-500 rounded-xl text-sm font-semibold"><I name="trash2" size={15} stroke="#ef4444"/>ì‚­ì œ</button>
                  </div>
                </div>
              ))
          )}
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ COMMUNITY SCREEN â”€â”€â”€ */
function CommunityScreen({ isLoggedIn, onWritePost, showAlert }) {
  const [cat,setCat]=useState('ì „ì²´');
  const categories=['ì „ì²´','ì½˜í‹° ê³µìœ ','ì°¬ì–‘ ì¶”ì²œ','ì˜ˆë°° ê³ ë¯¼','ìˆ˜ë ¨íšŒ ì •ë³´','ì•…ë³´ ìš”ì²­'];
  const handleWrite=()=>{
    if(!isLoggedIn){showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\ní”„ë¡œí•„ íƒ­ì—ì„œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.','ë¡œê·¸ì¸ í•„ìš”','info');return;}
    onWritePost();
  };
  return (
    <div className="h-full bg-gray-50 overflow-y-auto scrollbar-hide">
      <div className="px-6 py-8 shadow-lg" style={{background:"linear-gradient(135deg,#111827,#1f2937)"}}>
        <div className="max-w-2xl mx-auto flex justify-between items-center">
          <h2 className="text-2xl text-white font-bold">ì»¤ë®¤ë‹ˆí‹°</h2>
          <button onClick={handleWrite} className="px-5 py-2 bg-white text-gray-900 rounded-xl text-sm font-semibold hover:bg-gray-100 transition-colors shadow-md">ê¸€ì“°ê¸°</button>
        </div>
      </div>
      <div className="px-6 py-6 pb-6">
        <div className="max-w-2xl mx-auto fade-in">
          {!isLoggedIn&&<div className="bg-blue-50 border-l-4 border-blue-500 rounded-xl p-4 mb-4 text-sm text-gray-700">ğŸ’¡ ëŒ“ê¸€ê³¼ ì¢‹ì•„ìš”ëŠ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>}
          <div className="mb-5">
            <p className="text-xs text-gray-500 mb-2 font-medium">ì£¼ì œë³„</p>
            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
              {categories.map(c=>(
                <button key={c} onClick={()=>setCat(c)} className={`px-4 py-2 rounded-xl text-sm whitespace-nowrap font-medium transition-all ${cat===c?'bg-gray-900 text-white shadow-md':'bg-white border-2 border-gray-200 text-gray-600 hover:border-gray-900'}`}>{c}</button>
              ))}
            </div>
          </div>
          <div className="bg-white rounded-2xl border-2 border-gray-200 p-12 text-center">
            <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"><I name="messageCircle" size={36} stroke="#d1d5db"/></div>
            <h3 className="text-lg font-semibold text-gray-900 mb-2">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p className="text-sm text-gray-400 mb-6">ì²« ë²ˆì§¸ ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ì—¬ ì°¬ì–‘ ì‚¬ì—­ìë“¤ê³¼ ì†Œí†µí•´ë³´ì„¸ìš”</p>
            <button onClick={handleWrite} className="px-6 py-3 text-white rounded-xl font-semibold text-sm hover:opacity-90 transition-opacity" style={{background:"linear-gradient(135deg,#0d9488,#2563eb)"}}>ì²« ê²Œì‹œê¸€ ì‘ì„±í•˜ê¸°</button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ COMMUNITY POST SCREEN â”€â”€â”€ */
function CommunityPostScreen({ onBack, onPublish }) {
  const [cat,setCat]=useState('');
  const [title,setTitle]=useState('');
  const [content,setContent]=useState('');
  const [inc,setInc]=useState(false);
  const cats=['ì½˜í‹° ê³µìœ ','ì°¬ì–‘ ì¶”ì²œ','ì˜ˆë°° ê³ ë¯¼','ìˆ˜ë ¨íšŒ ì •ë³´','ì•…ë³´ ìš”ì²­'];
  const valid=cat&&title&&content;
  return (
    <div className="h-full bg-gray-50 overflow-y-auto scrollbar-hide">
      <div className="px-6 py-6 pb-6 pt-8">
        <div className="max-w-2xl mx-auto">
          <div className="flex items-center justify-between mb-6">
            <button onClick={onBack} className="flex items-center gap-1 text-gray-500 hover:text-gray-900 transition-colors"><I name="chevronLeft" size={18} stroke="currentColor"/><span className="text-sm">ë’¤ë¡œê°€ê¸°</span></button>
            <button onClick={()=>valid&&onPublish({category:cat,title,content,includeSongs:inc})} disabled={!valid} className="px-6 py-2 text-white rounded-xl text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed hover:opacity-90 transition-opacity" style={{background:"linear-gradient(135deg,#0d9488,#2563eb)"}}>ê²Œì‹œí•˜ê¸°</button>
          </div>
          <div className="bg-white rounded-2xl border-2 border-gray-200 p-6 space-y-4">
            <div>
              <label className="block text-sm text-gray-700 mb-2 font-medium">ì£¼ì œ ì„ íƒ *</label>
              <div className="flex gap-2 flex-wrap">
                {cats.map(c=><button key={c} onClick={()=>setCat(c)} className={`px-4 py-2 rounded-xl text-sm font-medium transition-all ${cat===c?'bg-gray-900 text-white':'bg-white border-2 border-gray-200 text-gray-700 hover:border-gray-900'}`}>{c}</button>)}
              </div>
            </div>
            <div>
              <label className="block text-sm text-gray-700 mb-2 font-medium">ì œëª© *</label>
              <input type="text" value={title} onChange={e=>setTitle(e.target.value)} placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-teal-500 focus:outline-none"/>
            </div>
            <div>
              <label className="block text-sm text-gray-700 mb-2 font-medium">ë‚´ìš© *</label>
              <textarea value={content} onChange={e=>setContent(e.target.value)} placeholder="ê²Œì‹œê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows={10} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-teal-500 focus:outline-none resize-none"/>
            </div>
            {cat==='ì½˜í‹° ê³µìœ '&&<div className="flex items-center gap-3 p-4 bg-teal-50 border-2 border-teal-200 rounded-xl"><input type="checkbox" id="inc" checked={inc} onChange={e=>setInc(e.target.checked)} className="w-5 h-5"/><label htmlFor="inc" className="text-sm text-gray-700 cursor-pointer">ë‚´ ì½˜í‹°ì—ì„œ ì°¬ì–‘ ëª©ë¡ ì²¨ë¶€í•˜ê¸°</label></div>}
          </div>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ SHEET MUSIC SCREEN (CCM ì•…ë³´ ê²€ìƒ‰ í¬í„¸) â”€â”€â”€ */
const BLOGS = [
  { id:'junseo', name:'ì¤€ì„œì˜ ì•…ë³´ì°½ê³ ', blogId:'0909junseo', desc:'CCM í”¼ì•„ë…¸ & ë°´ë“œ ì•…ë³´ ì „ë¬¸', grad:'from-emerald-500 to-teal-600', light:'bg-emerald-50', border:'border-emerald-200', text:'text-emerald-700', icon:'ğŸ¹', tags:['í”¼ì•„ë…¸','ë°´ë“œ','CCM'] },
  { id:'wkdghks', name:'ì°¬ì–‘ ì•…ë³´ ëª¨ìŒ', blogId:'wkdghks38811', desc:'ë‹¤ì–‘í•œ ì¥ë¥´ì˜ ì°¬ì–‘ ì•…ë³´ ê³µìœ ', grad:'from-blue-500 to-indigo-600', light:'bg-blue-50', border:'border-blue-200', text:'text-blue-700', icon:'ğŸ¼', tags:['ì°¬ì–‘','ì•…ë³´','ì½”ë“œ'] },
  { id:'relishsky', name:'ë¦´ë¦¬ì‰¬ìŠ¤ì¹´ì´ ì•…ë³´', blogId:'relishsky', desc:'ì˜ˆë°° ì°¬ì–‘ ì•…ë³´ & ì½”ë“œ ëª¨ìŒ', grad:'from-purple-500 to-violet-600', light:'bg-purple-50', border:'border-purple-200', text:'text-purple-700', icon:'ğŸµ', tags:['ì˜ˆë°°','ì°¬ì–‘','ì½”ë“œì•…ë³´'] },
  { id:'jskyscore', name:'ì œì´ìŠ¤ì¹´ì´ ìŠ¤ì½”ì–´', blogId:'jskyscore', desc:'ì „ë¬¸ í¸ê³¡ ì•…ë³´ & ì°¬ì–‘ ìë£Œ', grad:'from-rose-500 to-pink-600', light:'bg-rose-50', border:'border-rose-200', text:'text-rose-700', icon:'ğŸ¸', tags:['í¸ê³¡','ìŠ¤ì½”ì–´','ì „ë¬¸ì•…ë³´'] },
];

function SheetMusicScreen({ selectedSong }) {
  const [query, setQuery] = useState(selectedSong?.title || '');
  const [results, setResults] = useState(null); // null=ë¯¸ê²€ìƒ‰, []ì´ìƒ=ê²€ìƒ‰ì™„ë£Œ
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSearch = async (e) => {
    e.preventDefault();
    if (!query.trim()) return;
    setLoading(true);
    setError('');
    setResults(null);

    try {
      const searches = BLOGS.map(b =>
        fetch(`/api/search?query=${encodeURIComponent(query)}&blogId=${b.blogId}`)
          .then(r => r.json())
          .then(data => ({ ...b, ...data }))
          .catch(() => ({ ...b, hasResults: false, items: [], total: 0 }))
      );
      const all = await Promise.all(searches);
      setResults(all);
    } catch (err) {
      setError('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setLoading(false);
    }
  };

  const hasAny = results && results.some(r => r.hasResults);
  const found = results ? results.filter(r => r.hasResults) : [];
  const notFound = results ? results.filter(r => !r.hasResults) : [];

  return (
    <div className="h-full bg-gray-50 overflow-y-auto scrollbar-hide">
      <div className="px-6 py-8 shadow-lg" style={{background:"linear-gradient(135deg,#111827,#1f2937)"}}>
        <div className="max-w-2xl mx-auto">
          <div className="flex items-center gap-3 mb-1"><I name="music" size={22} stroke="#5eead4"/><h2 className="text-2xl text-white font-bold">CCM ì•…ë³´ ê²€ìƒ‰</h2></div>
          <p className="text-sm text-gray-400 mt-1">ì•…ë³´ê°€ ìˆëŠ” ë¸”ë¡œê·¸ë§Œ ê²°ê³¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</p>
        </div>
      </div>

      <div className="px-6 py-6 pb-10">
        <div className="max-w-2xl mx-auto fade-in">
          <form onSubmit={handleSearch} className="mb-6">
            <div className="relative flex items-center">
              <div className="absolute left-4 pointer-events-none"><I name="search" size={18} stroke="#9ca3af"/></div>
              <input
                type="text" value={query}
                onChange={e => { setQuery(e.target.value); setResults(null); setError(''); }}
                placeholder="ì°¾ê³  ì‹¶ì€ ì•…ë³´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                className="w-full pl-12 pr-28 py-4 rounded-2xl border-2 border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-100 transition-all text-sm shadow-sm"
              />
              <button type="submit" disabled={!query.trim() || loading}
                className="absolute right-2 px-5 py-2.5 bg-gray-900 text-white rounded-xl text-sm font-semibold hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed transition-all">
                {loading ? 'ê²€ìƒ‰ì¤‘...' : 'ê²€ìƒ‰'}
              </button>
            </div>
          </form>

          {loading && (
            <div className="text-center py-12">
              <div className="w-12 h-12 border-4 border-teal-200 border-t-teal-500 rounded-full animate-spin mx-auto mb-4"/>
              <p className="text-sm text-gray-500">4ê°œ ë¸”ë¡œê·¸ì—ì„œ ì•…ë³´ë¥¼ ì°¾ëŠ” ì¤‘...</p>
              <div className="flex justify-center gap-2 mt-4">
                {BLOGS.map(b => <span key={b.id} className="text-lg animate-pulse">{b.icon}</span>)}
              </div>
            </div>
          )}

          {error && <div className="p-4 bg-red-50 border-2 border-red-200 rounded-2xl text-sm text-red-700 mb-4">{error}</div>}

          {!loading && results === null && (
            <div className="text-center py-8">
              <div className="w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center mx-auto mb-4"><I name="bookOpen" size={36} stroke="#0d9488"/></div>
              <h3 className="text-gray-800 font-semibold text-lg mb-2">ì•…ë³´ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3>
              <p className="text-sm text-gray-400 mb-8">ê³¡ ì œëª©ì„ ì…ë ¥í•˜ë©´ 4ê°œ ë¸”ë¡œê·¸ì—ì„œ<br/>ì‹¤ì œë¡œ ì•…ë³´ê°€ ìˆëŠ” ê³³ë§Œ í‘œì‹œë¼ìš”</p>
              <div className="grid grid-cols-2 gap-3 text-left">
                {BLOGS.map(b => (
                  <div key={b.id} className={`${b.light} ${b.border} border rounded-2xl p-4`}>
                    <div className="flex items-center gap-2 mb-2"><span className="text-xl">{b.icon}</span><span className={`text-sm font-bold ${b.text}`}>{b.name}</span></div>
                    <p className="text-xs text-gray-400">{b.desc}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {!loading && results !== null && (
            <>
              <div className="flex items-center justify-between mb-4">
                <p className="text-sm text-gray-500">
                  <span className="font-semibold text-gray-900">"{query}"</span> â€” 
                  {hasAny
                    ? <span className="text-teal-600 font-semibold">{found.length}ê°œ ë¸”ë¡œê·¸ì—ì„œ ë°œê²¬!</span>
                    : <span className="text-gray-400">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</span>
                  }
                </p>
              </div>

              {found.length > 0 && (
                <div className="space-y-4 mb-6">
                  {found.map(b => (
                    <div key={b.id} className="bg-white rounded-2xl border-2 border-teal-200 shadow-lg overflow-hidden">
                      <div className="flex items-center gap-3 px-4 py-3" style={{background:`linear-gradient(135deg,#f0fdfa,#e0f2fe)`}}>
                        <span className="text-xl">{b.icon}</span>
                        <div className="flex-1">
                          <span className={`text-sm font-bold ${b.text}`}>{b.name}</span>
                          <span className="ml-2 text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded-full font-semibold">{b.total}ê±´ ë°œê²¬</span>
                        </div>
                        <a href={`https://blog.naver.com/${b.blogId}?Redirect=Search&keyword=${encodeURIComponent(query)}`}
                          target="_blank" rel="noopener noreferrer"
                          className="text-xs text-gray-400 hover:text-teal-600 flex items-center gap-1 transition-colors">
                          ì „ì²´ë³´ê¸° <I name="externalLink" size={12} stroke="currentColor"/>
                        </a>
                      </div>
                      <div className="divide-y divide-gray-100">
                        {b.items.map((item, idx) => (
                          <a key={idx} href={item.link} target="_blank" rel="noopener noreferrer"
                            className="block px-4 py-3 hover:bg-gray-50 transition-colors">
                            <p className="text-sm font-semibold text-gray-900 mb-1 line-clamp-1">{item.title}</p>
                            <p className="text-xs text-gray-400 line-clamp-2 leading-relaxed">{item.description}</p>
                            <p className="text-xs text-gray-300 mt-1">{item.postdate?.replace(/(\d{4})(\d{2})(\d{2})/,'$1.$2.$3')}</p>
                          </a>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {notFound.length > 0 && (
                <div className="mb-5">
                  <p className="text-xs text-gray-400 mb-2 font-medium">ì´ ë¸”ë¡œê·¸ì—ëŠ” ê²°ê³¼ê°€ ì—†ì–´ìš”</p>
                  <div className="flex gap-2 flex-wrap">
                    {notFound.map(b => (
                      <span key={b.id} className="flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 rounded-xl text-xs text-gray-400">
                        <span>{b.icon}</span>{b.name}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {!hasAny && (
                <div className="p-5 bg-gray-100 rounded-2xl text-center mb-4">
                  <p className="text-sm text-gray-500 mb-1 font-medium">4ê°œ ë¸”ë¡œê·¸ ëª¨ë‘ì—ì„œ ì°¾ì§€ ëª»í–ˆì–´ìš”</p>
                  <p className="text-xs text-gray-400 mb-4">ê³¡ëª… í‘œê¸°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ìš” (ì˜ˆ: ì˜ë¬¸ëª…, ë„ì–´ì“°ê¸° ë“±)</p>
                  <a href={`https://search.naver.com/search.naver?query=${encodeURIComponent(query+' CCM ì•…ë³´')}`}
                    target="_blank" rel="noopener noreferrer"
                    className="inline-flex items-center gap-2 px-5 py-2.5 bg-green-500 text-white rounded-xl text-sm font-semibold hover:bg-green-600 transition-colors">
                    <I name="search" size={16} stroke="#fff"/>ë„¤ì´ë²„ ì „ì²´ ê²€ìƒ‰í•˜ê¸°
                  </a>
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ PROFILE SCREEN â”€â”€â”€ */
function ProfileScreen({ isLoggedIn, onLogin, onLogout }) {
  const [email,setEmail]=useState('');
  const [pw,setPw]=useState('');
  const [err,setErr]=useState('');
  const [loggedEmail,setLoggedEmail]=useState('');
  
  // í…ŒìŠ¤íŠ¸ìš© ê³„ì • ë³€ê²½: ì•„ì´ë”” 1234 / ë¹„ë°€ë²ˆí˜¸ 1234
  const ADMIN='1234', APW='1234';

  const doLogin=()=>{
    // ì´ë©”ì¼ í˜•ì‹ ê²€ì‚¬ ë¡œì§ ì œê±° (1234ë„ ì…ë ¥ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½)
    if(email===ADMIN&&pw===APW){setLoggedEmail(email);onLogin();setErr('');}
    else setErr('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  };

  const doLogout=()=>{ setLoggedEmail('');setEmail('');setPw('');onLogout(); };

  if(!isLoggedIn) return (
    <div className="h-full flex items-center justify-center px-6 overflow-y-auto relative" style={{background:"linear-gradient(135deg,#111827,#1f2937,#000)"}}>
      <div className="absolute top-0 right-0 w-96 h-96 rounded-full blur-3xl" style={{background:"rgba(20,184,166,0.06)"}}/>
      <div className="w-full max-w-sm py-12 relative z-10 fade-in">
        <div className="mb-8"><Logo size="md"/></div>
        <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8 border border-gray-200">
          <h2 className="text-xl mb-6 text-gray-900 font-bold">ë¡œê·¸ì¸</h2>
          <div className="space-y-4 mb-5">
            <div>
              <label className="block text-sm text-gray-700 mb-2 font-medium">ì•„ì´ë””</label>
              <input type="text" value={email} onChange={e=>{setEmail(e.target.value);setErr('');}} placeholder="1234" className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-teal-500 focus:outline-none transition-colors"/>
            </div>
            <div>
              <label className="block text-sm text-gray-700 mb-2 font-medium">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" value={pw} onChange={e=>{setPw(e.target.value);setErr('');}} onKeyDown={e=>e.key==='Enter'&&doLogin()} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-teal-500 focus:outline-none transition-colors"/>
            </div>
          </div>
          {err&&<div className="mb-4 p-3 bg-red-50 border-2 border-red-200 rounded-xl text-sm text-red-700">{err}</div>}
          <button onClick={doLogin} className="w-full py-3 bg-gray-900 text-white rounded-xl font-semibold mb-3 hover:bg-gray-800 transition-colors shadow-lg">ë¡œê·¸ì¸</button>
          <button className="w-full py-3 border-2 border-gray-200 text-gray-700 rounded-xl font-semibold hover:border-gray-900 transition-colors">íšŒì›ê°€ì…</button>
        </div>
      </div>
    </div>
  );

  return (
    <div className="h-full bg-gray-50 overflow-y-auto scrollbar-hide">
      <div className="px-6 py-8 shadow-lg" style={{background:"linear-gradient(135deg,#111827,#1f2937)"}}>
        <div className="max-w-2xl mx-auto flex items-center gap-4">
          <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-lg"><span className="text-xl text-gray-900 font-bold">{loggedEmail.slice(0,1).toUpperCase()||'U'}</span></div>
          <div><p className="text-xs text-gray-400">í™˜ì˜í•©ë‹ˆë‹¤</p><p className="text-base text-white font-bold">{loggedEmail||'ì‚¬ìš©ì'}</p></div>
        </div>
      </div>
      <div className="px-6 py-6">
        <div className="max-w-2xl mx-auto space-y-4 fade-in">
          {[
            {title:'ì„¤ì •', items:[{icon:'bell',label:'ì•Œë¦¼ ì„¤ì •',sub:'í‘¸ì‹œ ì•Œë¦¼ ë° ì´ë©”ì¼ ì„¤ì •'},{icon:'settings',label:'ê³„ì • ì„¤ì •',sub:'í”„ë¡œí•„ ë° ë³´ì•ˆ ì„¤ì •'}]},
            {title:'ë„ì›€ë§', items:[{icon:'help',label:'FAQ',sub:'ìì£¼ ë¬»ëŠ” ì§ˆë¬¸'},{icon:'info',label:'Wolea ì†Œê°œ',sub:'ì„œë¹„ìŠ¤ ì•ˆë‚´ ë° ìš”ê¸ˆì œ'}]},
          ].map(sec=>(
            <div key={sec.title} className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200">
              <div className="px-6 py-3" style={{background:"linear-gradient(135deg,#1f2937,#374151)"}}><p className="text-sm text-white font-semibold">{sec.title}</p></div>
              <div className="divide-y divide-gray-100">
                {sec.items.map(item=>(
                  <button key={item.label} className="w-full p-5 flex items-center gap-4 hover:bg-gray-50 transition-colors">
                    <div className="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center"><I name={item.icon} size={18} stroke="#374151"/></div>
                    <div className="text-left"><p className="text-gray-900 font-semibold text-sm">{item.label}</p><p className="text-xs text-gray-400">{item.sub}</p></div>
                  </button>
                ))}
              </div>
            </div>
          ))}
          <button onClick={doLogout} className="w-full p-5 bg-white rounded-2xl shadow-lg border-2 border-red-400 flex items-center justify-center gap-3 hover:bg-red-50 transition-colors">
            <I name="logout" size={18} stroke="#ef4444"/><span className="text-red-500 font-semibold">ë¡œê·¸ì•„ì›ƒ</span>
          </button>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ MAIN APP â”€â”€â”€ */
function App() {
  const [activeTab,setActiveTab]=useState('ai');
  const [screen,setScreen]=useState('welcome');
  const [isLoggedIn,setIsLoggedIn]=useState(false);
  const [medData,setMedData]=useState({input:''});
  const [worshipData,setWorshipData]=useState(null);
  const [savedSetlists,setSavedSetlists]=useState([]);
  const [deletedSetlists,setDeletedSetlists]=useState([]);
  const [selectedSetlistId,setSelectedSetlistId]=useState(null);
  const [selectedSheet,setSelectedSheet]=useState(null);
  const [guidanceCountdown,setGuidanceCountdown]=useState(null);
  const [communityView,setCommunityView]=useState('list');
  const [alert,setAlert]=useState({isOpen:false,message:''});
  
  const [generatedSongs, setGeneratedSongs] = useState([]);

  const showAlert=(message,title,type='info')=>setAlert({isOpen:true,title,message,type});
  const closeAlert=()=>setAlert(a=>({...a,isOpen:false}));

  const generateSetlistFromAPI = async (wData, mData, prompt = null) => {
    try {
      setScreen('generating');
      
      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ worshipData: wData, meditationData: mData })
      });
      
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'AI ì½˜í‹° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      
      setGeneratedSongs(data.songs);
      setScreen('result');
      
      const ns={id:Date.now().toString(),date:new Date().toLocaleDateString('ko-KR'),serviceType:wData.serviceType,theme:wData.theme,meditationData:mData,worshipData:wData, songs: data.songs, createdAt:Date.now()};
      setSavedSetlists(prev=>[ns,...prev]);
    } catch (error) {
      showAlert(error.message, 'ì˜¤ë¥˜ ë°œìƒ', 'error');
      setScreen('worship-info');
    }
  };

// 1. í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ íƒ­ ë³€ê²½ ë¡œì§ (ìŒí‘œ ì•„ì´ì½˜ í´ë¦­ ì‹œ ì œí•œ í•´ì œ)
  const handleTabChange=(tab)=>{
    setActiveTab(tab);
    if(tab==='community')setCommunityView('list');
    if(tab==='ai'&&screen!=='result'&&screen!=='guidance'&&screen!=='generating')setScreen('welcome');
  };

  const handleWorshipSubmit=(data)=>{
    setWorshipData(data);
    generateSetlistFromAPI(data, medData);
  };

  const handleStartOver=()=>{setMedData({input:''});setWorshipData(null);setSelectedSetlistId(null);setGuidanceCountdown(null);setGeneratedSongs([]);setScreen('welcome');};

  const handleRegenerate=()=>{generateSetlistFromAPI(worshipData, medData);};

// 2. ì½˜í‹° í™”ë©´ì—ì„œ ì•…ë³´ ë³´ê¸° ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ë¡œì§ (ì œí•œ í•´ì œ)
  const handleViewSheetMusic=(title,artist)=>{
    setSelectedSheet({title,artist});
    setActiveTab('music');
  };

  const handleViewSetlist=(id)=>{
    const s=savedSetlists.find(x=>x.id===id);
    if(s){setSelectedSetlistId(id);setMedData(s.meditationData);setWorshipData(s.worshipData);setGeneratedSongs(s.songs || []);setScreen('result');setActiveTab('ai');}
  };

  const handleDeleteSetlist=(id)=>{
    const s=savedSetlists.find(x=>x.id===id);
    if(s){setDeletedSetlists(prev=>[{...s,deletedAt:Date.now()},...prev]);setSavedSetlists(prev=>prev.filter(x=>x.id!==id));if(selectedSetlistId===id){setSelectedSetlistId(null);handleStartOver();}}
  };

  const renderContent=()=>{
    if(activeTab==='ai'){
      if(screen==='welcome') return <WelcomeScreen onContinue={()=>setScreen('meditation')}/>;
      if(screen==='meditation') return <MeditationInputScreen onSubmit={input=>{setMedData({input});setScreen('guidance');setGuidanceCountdown(60);}}/>;
      if(screen==='guidance') return <MeditationGuidanceScreen onContinue={()=>{if(!isLoggedIn){showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\ní”„ë¡œí•„ íƒ­ì—ì„œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.','ë¡œê·¸ì¸ í•„ìš”','info');setActiveTab('profile');return;}setScreen('worship-info');}} onBack={()=>setScreen('meditation')} countdown={guidanceCountdown} setCountdown={setGuidanceCountdown} meditationInput={medData.input}/>;
      if(screen==='worship-info') return <WorshipInfoScreen onSubmit={handleWorshipSubmit}/>;
      if(screen==='generating') return <GeneratingScreen/>;
      if(screen==='result') return <SetlistResultScreen generatedSongs={generatedSongs} meditationData={medData} worshipData={worshipData} onStartOver={handleStartOver} onRegenerate={handleRegenerate} onViewSheetMusic={handleViewSheetMusic} onEditSetlist={prompt=>{
        generateSetlistFromAPI(worshipData, medData, prompt); 
        setTimeout(()=>{showAlert(`"${prompt}" í”„ë¡¬í”„íŠ¸ë¡œ ì½˜í‹°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`,'ì½˜í‹° ìˆ˜ì • ì™„ë£Œ','success');},2000);
      }}/>;
    }
    if(activeTab==='setlists') return <MySetlistsScreen setlists={savedSetlists} deletedSetlists={deletedSetlists} onViewSetlist={handleViewSetlist} onDeleteSetlist={handleDeleteSetlist} onRestoreSetlist={id=>{const s=deletedSetlists.find(x=>x.id===id);if(s){const{deletedAt,...r}=s;setSavedSetlists(prev=>[r,...prev]);setDeletedSetlists(prev=>prev.filter(x=>x.id!==id));}}} onPermanentDelete={id=>setDeletedSetlists(prev=>prev.filter(x=>x.id!==id))} isLoggedIn={isLoggedIn}/>;
    if(activeTab==='community') return communityView==='post' ? <CommunityPostScreen onBack={()=>setCommunityView('list')} onPublish={post=>{showAlert(`ì œëª©: ${post.title}`,'ê²Œì‹œê¸€ì´ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!','success');setCommunityView('list');}}/> : <CommunityScreen isLoggedIn={isLoggedIn} onWritePost={()=>setCommunityView('post')} showAlert={showAlert}/>;
    if(activeTab==='music') return <SheetMusicScreen selectedSong={selectedSheet}/>;
    if(activeTab==='profile') return <ProfileScreen isLoggedIn={isLoggedIn} onLogin={()=>setIsLoggedIn(true)} onLogout={()=>{setIsLoggedIn(false);setSavedSetlists([]);}} />;
    return null;
  };

  return (
    <div className="h-screen overflow-hidden bg-gray-50" style={{maxWidth:'480px',margin:'0 auto',position:'relative'}}>
      <div style={{height:'calc(100vh - 5rem)',overflowY:'auto'}} className="scrollbar-hide">
        {renderContent()}
      </div>
      <BottomNav activeTab={activeTab} onTabChange={handleTabChange}/>
      <CustomAlert {...alert} onClose={closeAlert}/>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
